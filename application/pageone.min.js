import{CTableData,enumReturn}from"./../library/TableData.js";import{CTableDataTrigger}from"./../library/TableDataTrigger.js";import{CUIPagerPreviousNext}from"./../library/UIPagerPreviousNext.js";import{CDispatch}from"./../library/Dispatch.js";import{CUITableText}from"./../library/UITableText.js";import{CQuery}from"./../server/Query.js";import{CPageSuper,CPageState}from"./pagesuper.js";import{CD3Bar}from"./pageone_d3.js";export class CPageOne extends CPageSuper{constructor(e,t){super(e,t);const l=t||{};this.m_oD3Bar=new CD3Bar,this.m_bFilterConditionCount=!1,this.m_oPoll={poll:-1,vote:-1,count:0},this.m_sQueriesSet=l.set||"",this.m_sSession=l.session||null,this.m_oState=l.state||{},this.m_oUITableText={},this.m_sViewMode="vote",this.m_aPageState=[new CPageState({section:"body",name:"vote",container:document.getElementById("idPollVote"),query:[["poll_question_list",0,[]],["poll_answer",0,[]]]}),new CPageState({section:"body",name:"count",container:document.getElementById("idPollFilterCount"),query:[["poll_question_list",0,[]],["poll_answer_count",0,[]]]}),new CPageState({section:"body",name:"search",container:document.getElementById("idPollSearch"),isolated:!0,query:[["poll_search",0,!1]]}),new CPageState({section:"body",name:"select",container:null,query:[["poll_question_list",0,[]],["poll_answer",0,[]]]})],this.m_oElement={error:document.getElementById("idError"),message:document.getElementById("idMessage"),warning:document.getElementById("idWarning")},this.m_aVoter=[-1,"",""],this.m_aVoteHistory=[],this.HISTORYSerialize(!1)}get app(){return this.m_oApplication}get poll(){return this.m_oPoll}get queries_set(){return this.m_sQueriesSet}get state(){return this.m_oState}get search_mode(){return this.m_sSearchMode}set search_mode(e){this.m_sSearchMode=e}get view_mode(){return this.m_sViewMode}set view_mode(e){console.assert("vote"===e||"count"===e||"search"===e||"select"===e,"Invalid view mode: "+e),this.m_sViewMode=e}set voter(e){this.m_aVoter=e}GetActivePoll(){return this.poll.poll}SetActivePoll(e,t){if(this.CloseQuestions(),this.m_oD3Bar&&this.m_oD3Bar.DeleteQuestion(),e!==this.GetActivePoll()&&(document.getElementById("idPollOverview").querySelector('[data-section="result_vote_count"]').style.display="none"),"number"==typeof e&&(this.poll.poll=e,e<=0))return void this.RESULTCreatePollOverview("idPollOverview");this.QUERYGetPollOverview(this.poll.poll,t);const l=[[{ready:!1,table:"TPollQuestion1",id:"PollK",value:this.poll.poll,simple:t}]];this.m_oPageState?this.m_oPageState.SetActive(l):this.SetActiveState("body."+this.view_mode,void 0,l),this.WalkNextState()}IsVoter(){return-1!==this.m_aVoter[0]}GetPageState(e,t){for(let l=0;l<this.m_aPageState.length;l++){const o=this.m_aPageState[l];if(e===o.section&&t===o.name)return o}return console.assert(!1,"state not found"),null}SetActiveState(e,t,l){const[o,a]=e.split(".");if("body"===o){this.view_mode=a;let e=this.GetPageState(o,a);for(let e=0;e<this.m_aPageState.length;e++){const t=this.m_aPageState[e];o===t.section&&t.SetActive()}e.SetActive(l),this.m_oPageState=e}}WalkNextState(){if(!this.m_oPageState)return;let e=this.app.request,t=this.m_oPageState.GetOngoingQuery();if(null===t)return this.m_oPageState.Reset(),void(!1===this.m_oPageState.IsIsolated()?(this.m_oPageState=null,this.QUERYGetPollFilterCount(this.GetActivePoll())):this.m_oPageState=null);if(2===t[1]){let e=t[2];if("boolean"!=typeof e){let l=0;for(;l<e.length&&!0===e[l].ready;);l<e.length&&(e[l].ready=!0,l++),l<e.length?t[1]=0:t=this.m_oPageState.GetOngoingQuery()}else t=this.m_oPageState.GetOngoingQuery()}if(t&&0===t[1]){let l,o=t[2];if(o){let e=new CQuery;for(let t=0;t<o.length;t++){let l=o[t];if(!1===l.ready){e.CONDITIONAdd(l),l.ready=!0;break}}l=e.CONDITIONGetXml()}const a=t[0];let i={command:"add_condition_to_query get_result",delete:1,query:a,set:this.queries_set,count:50,format:1,start:0};"poll_search"===a&&(i.count=10),l||delete i.delete,e.Get("SCRIPT_Run",{file:"/PAGE_result.lua",json:e.GetJson(i)},l),t[1]=1}else console.assert(!1,"we should not go here"),this.m_oPageState=null,this.m_oD3Bar.Render(this.m_bFilterConditionCount)}CloseQuestions(){document.getElementById("idPollVote").innerHTML="",document.getElementById("idPollFilterCount").innerHTML="",this.OpenMessage()}IsReadyToVote(e){let t=this.GetPageState("body","vote"),l=t.GetTableData(),o=0;l.forEach(e=>{!0===e.external.ready&&o++});const a=l.length===o;if(!0===e){let e=t.container.querySelector('[data-section="vote"]').querySelector("button");e&&(a?e.removeAttribute("disabled"):e.setAttribute("disabled",""))}return a}SendVote(){console.assert(this.GetActivePoll()>0,"Active poll isn't set."),console.assert(this.IsReadyToVote(),"Trying to send vote to server but vote isn't ready to be sent.");let e=[];const t=this.GetPageState("body","vote").GetTableData();t.forEach(t=>{const l=t.CountValue([-1,"check"],1,enumReturn.Array);l.forEach(l=>{e.push({index:2,value:t.CELLGetValue(l,"PollAnswerK")})})});let l=[{name:"PollK",value:this.GetActivePoll()}];-1!==this.m_aVoter[0]&&l.push({name:"VoterK",value:this.m_aVoter[0]});let o=new CQuery({header:l,values:e}),a=(new DOMParser).parseFromString("<document/>","text/xml");o.HEADERGetXml({document:!0},a),e.forEach((e,t)=>{o.values=e,o.VALUEGetXml({index:t,values:"row",document:!0},a)});const i=(new XMLSerializer).serializeToString(a);let n={command:"add_rows",query:"poll_vote",set:this.queries_set,table:"TPollVote1"},r=this.app.request;r.Get("SCRIPT_Run",{file:"PAGE_result_edit.lua",json:r.GetJson(n)},i),this.poll.vote=this.poll.poll}ProcessResponse(e,t,l){if(null===e)return void("user"===t&&this.app.GetSession());let o=JSON.parse(e.textContent);switch(t){case"delete_condition":break;case"result":{const e=o.name;if(this.m_oPageState&&this.m_oPageState.GetQueryName()===e){let t=this.m_oPageState.GetOngoingQuery();switch(t[1]=2,e){case"poll_question_list":this.RESULTCreateQuestionPanel(this.m_oPageState.container,o);break;case"poll_answer":this.RESULTCreateVote(this.m_oPageState.container,o);break;case"poll_answer_count":this.RESULTCreateVoteCountAndFilter(this.m_oPageState.container,o);break;case"poll_search":this.RESULTCreateSearch(this.m_oPageState.container,o);break;default:console.assert(!1,`Result for ${e} has no stub`)}if("boolean"!=typeof t[2]){let e=t[2],l=0;for(;l<e.length&&!0===e[l].ready;)l++;l<e.length&&(t[1]=0)}return void this.WalkNextState()}"poll_overview"===e?this.RESULTCreatePollOverview("idPollOverview",o):"poll_links"===e?this.RESULTCreatePollOverviewLinks("idPollOverview",o):"poll_answer_filtercount"===e?this.RESULTCreatePollFilterCount("idPollOverview",o):"poll_search"===e&&this.RESULTCreateSearch("idPollSearch",o)}break;case"load_if_not_found":this.CallOwner("load");break;case"query_conditions":"poll_answer_filtercount"===l&&this.CONDITIONMarkFilterVote(o);break;case"message":const e=o.type;if("add_rows"===e){const e=o.name;"poll_vote"===e?(this.OpenMessage("Din röst har blivit registrerad!"),this.poll.vote>0&&(this.m_aVoteHistory.push(this.poll.vote),this.HISTORYSerialize(!0),this.QUERYGetPollFilterCount(this.GetActivePoll())),this.poll.vote=-1):"login"===e&&this.CallOwner("insert-voter")}break;default:{let e=t.indexOf("get_query_information-");0===e&&"poll_search"===o.name&&this.PAGECreateToolbarForSearch(o)}}}QUERYGetPollOverview(e,t){let l=this.app.request,o=new CQuery({conditions:[{table:"TPoll1",id:"PollK",value:e,simple:t}]}),a=o.CONDITIONGetXml(),i={command:"add_condition_to_query get_result",delete:1,query:"poll_overview",set:this.queries_set,count:50,format:1,start:0};l.Get("SCRIPT_Run",{file:"/PAGE_result.lua",json:l.GetJson(i)},a)}QUERYGetPollLinks(e){let t=this.app.request,l=new CQuery({conditions:[{table:"TPoll1",id:"PollK",value:e}]}),o=l.CONDITIONGetXml(),a={command:"add_condition_to_query get_result",delete:1,query:"poll_links",set:this.queries_set,count:50,format:1,start:0};t.Get("SCRIPT_Run",{file:"/PAGE_result.lua",json:t.GetJson(a)},o)}QUERYGetPollFilterCount(e){let t=this.app.request;const l="poll_answer_filtercount";let o,a={command:"add_condition_to_query get_result",query:l,set:this.queries_set,count:100,format:1,start:0};"number"==typeof e?(o=[{table:"TPoll1",id:"PollK",value:e}],a.delete=1):"number"==typeof e.answer?(o=[{table:"TPollVote1",id:"TieFilterAnswer",value:e.answer}],a.command="add_condition_to_query get_query_conditions get_result"):"string"==typeof e.condition&&(a.command="delete_condition_from_query get_query_conditions get_result",a.uuid=e.condition);let i=new CQuery({conditions:o}),n=i.CONDITIONGetXml();this.m_bFilterConditionCount=!1,t.Get("SCRIPT_Run",{file:"/PAGE_result.lua",hint:l,json:t.GetJson(a)},n)}QUERYGetSearch(e){const t=e.start||0;let l=this.app.request,o="",a={query:"poll_search",set:this.queries_set,count:10,format:1,start:t};e.snapshot&&(a.name=e.snapshot,o+=" set_snapshot"),o+=" get_result",a.command=o,l.Get("SCRIPT_Run",{file:"/PAGE_result.lua",hint:"poll_search",json:l.GetJson(a)})}RESULTCreatePollOverview(e,t){if("string"==typeof e&&(e=document.getElementById(e)),void 0===t)return e.style.display="none",void(document.getElementById("idContent").style.display="none");e.style.display="block",document.getElementById("idContent").style.display="block";let l=new CTableData({id:t.id,name:t.name});CPageSuper.ReadColumnInformationFromHeader(l,t.table.header),l.ReadArray(t.table.body,{begin:0});const o=l.CELLGetValue(0,1),a=l.CELLGetValue(0,2),i=l.CELLGetValue(0,3),n=l.CELLGetValue(0,"CountLink"),r=l.CELLGetValue(0,"MyCount"),s=l.CELLGetValue(0,"IpCount");if(this.poll.count="number"==typeof r?r:0,!1===this.IsVoter()&&s>0&&(this.poll.count=s),this.poll.count=0,i>0){let t=e.querySelector("[data-title]");t.textContent=o;let l=e.querySelector("[data-description]");l&&(l.textContent=a||"");let n=e.querySelector("[data-count]");n&&(n.textContent=i.toString())}let d=e.querySelector('[data-section="link"]');n>0?(d.style.display="block",this.QUERYGetPollLinks(this.GetActivePoll())):d.style.display="none"}RESULTCreateVote(e,t){"string"==typeof e&&(e=document.getElementById(e));let l=new CTableData({id:t.id,name:t.name,external:{max:1,min:1}});const o=t.table.header;CPageSuper.ReadColumnInformationFromHeader(l,o,(e,t,l)=>{t.key&&l.COLUMNSetPropertyValue(e,"position.hide",!0)}),l.ReadArray(t.table.body,{begin:0});let a=l.CELLGetValue(0,0);for(let e=0,t=l.ROWGetCount();e<t;e++)this.m_oD3Bar.AddAnswer(a,[l.CELLGetValue(e,"PollAnswerK"),l.CELLGetValue(e,"FName"),0,0]);if(this.m_oPageState.AddTableData(a,l),!e)return;let i=l.InsertColumn(2,0,1);CTableData.SetPropertyValue(i,!0,"id","check"),CTableData.SetPropertyValue(i,!0,"alias","Röst"),CTableData.SetPropertyValue(i,!0,"edit.name","checkbox"),CTableData.SetPropertyValue(i,!0,"edit.edit",!0),CTableData.SetPropertyValue(i,!0,"edit.element",1),l.COLUMNUpdatePositionIndex();let n=e.querySelector(`section[data-question="${a}"]`),r=n.querySelector("article"),s={html_group:"table.table",html_row:"tr",html_cell_header:"th",html_cell:"td",html_section_header:"thead",html_section_body:"tbody",html_section_footer:"tfoot"},d=new CTableDataTrigger({table:l,trigger:CPageSuper.CallbackVote}),u={parent:r,section:["title","table.header","table.body","footer"],table:l,name:"vote",style:s,edit:1,state:17,trigger:d},c=new CUITableText(u);l.UIAppend(c),c.COLUMNSetRenderer(0,(e,t,l)=>{e.querySelector("div");let o="";"1"!==t&&1!==t||(o="checked");let a=document.createElement("div");a.innerHTML=`\n<label class="vote-check" data-style="rounded" data-color="green" data-size="lg">\n<input ${o} type="checkbox" data-value="1" data-commit="1" value="1">\n<span class="toggle">\n<span class="switch"></span>\n</span>\n</label>`,e.appendChild(a)}),c.Render();let m=c.GetSection("footer");m.innerHTML="<div>\n<span data-info=\"data\" style='display: inline-block; margin-left: 3em;'></span>\n<span data-info=\"xml\" style='display: inline-block; margin-left: 3em;'></span>\n</div>"}RESULTCreatePollOverviewLinks(e,t){"string"==typeof e&&(e=document.getElementById(e));let l=new CTableData({id:t.id,name:t.name});CPageSuper.ReadColumnInformationFromHeader(l,t.table.header),l.ReadArray(t.table.body,{begin:0});let o=e.querySelector('[data-section="link"]'),a=o.lastElementChild;for(;"A"===a.tagName;){let e=a;a=a.previousElementSibling,e.remove()}const i=l.ROWGetCount();let n=document.createElement("div");for(let e=0;e<i;e++){const t=l.CELLGetValue(e,1);n.innerHTML=t;let a=n.firstElementChild;a.className="panel-block",o.appendChild(a)}}RESULTCreatePollFilterCount(e,t){"string"==typeof e&&(e=document.getElementById(e));let l=new CTableData({id:t.id,name:t.name});CPageSuper.ReadColumnInformationFromHeader(l,t.table.header),l.ReadArray(t.table.body,{begin:0}),l.COLUMNSetPropertyValue("PollQuestionK","position.hide",!0),l.COLUMNSetPropertyValue("PollVoteK","position.hide",!1),l.COLUMNSetPropertyValue("Question","alias","Fråga"),l.COLUMNSetPropertyValue("Answer","alias","Svar"),l.COLUMNSetPropertyValue("PollVoteK","alias","Antal röster"),l.COLUMNSetType("PollVoteK","number"),!0===this.m_bFilterConditionCount&&this.m_oD3Bar.ResetFilterCount();for(let e=0,t=l.ROWGetCount();e<t;e++){let t=[void 0,void 0];!0===this.m_bFilterConditionCount?t[1]=l.CELLGetValue(e,"Count"):t[0]=l.CELLGetValue(e,"Count"),this.m_oD3Bar.SetAnswerCount(l.CELLGetValue(e,"PollQuestionK"),l.CELLGetValue(e,"Answer"),t)}let o=e.querySelector('[data-section="result_vote_count"]');o.innerHTML="";let a={html_group:"table.table",html_row:"tr",html_cell_header:"th",html_cell:"td",html_section_header:"thead",html_section_body:"tbody"},i={parent:o,section:["table.header","table.body"],table:l,style:a},n=new CUITableText(i);l.UIAppend(n),n.COLUMNSetRenderer(0,(e,t,l)=>{const o=l[0][0];if(o>0){const e=n.GetBodyValue(o-1,0);if(e===t)return}let a=document.createElement("b");a.innerText=t,e.appendChild(a)}),n.Render(),this.m_oD3Bar.Render(this.m_bFilterConditionCount)}RESULTCreateQuestionPanel(e,t){let l=new CTableData({id:t.id,name:t.name});CPageSuper.ReadColumnInformationFromHeader(l,t.table.header),l.ReadArray(t.table.body,{begin:0});let o=document.getElementById("idPollOverview").querySelector('[data-section="d3bars"]');if(o.innerHTML="","string"==typeof e&&(e=document.getElementById(e)),e){let t=e.querySelector('[data-section="question"]');if(t||(t=document.createElement("div"),t.dataset.section="question",e.appendChild(t)),"vote"===this.view_mode){let t=e.querySelector('[data-section="vote"]');if(t=document.createElement("div"),t.dataset.section="vote",t.className="has-text-info is-size-4",e.appendChild(t),!1===this.HISTORYFindPoll(this.GetActivePoll())&&this.poll.count<1){t&&(t.innerHTML="<button class='button is-white is-rounded is-primary is-large' style='width: 300px;'>RÖSTA</button>");let e=t.querySelector("button");e.setAttribute("disabled",""),e.addEventListener("click",e=>{e.srcElement.style.display="none",this.SendVote()})}else t.innerText="Röst är registrerad för aktuell fråga."}}let a=l.GetData()[0],i=[];a.forEach((t,l)=>{const a=t[0],n=t[1],r=l+1;if(i.push({ready:!1,table:"TPollQuestion1",id:"PollQuestionK",value:a}),e){let t=e.querySelector('[data-section="question"]'),l=document.createElement("section");l.dataset.question=a.toString(),l.className="block",l.style.margin="1em",l.innerHTML=`<header class="title is-3">${r}: ${n}</header><article style="display: block;"></article>`,t.appendChild(l)}let s=document.createElement("section");s.className="block box",s.style.padding="0.5em",s.innerHTML='<div class="is-size-6 has-text-weight-semibold" data-type="title"></div><div data-type="chart"></div>';let d=s.querySelector('[data-type="title"]');d.innerText=n;let u=s.querySelector('[data-type="chart"]');this.m_oD3Bar.AddQuestion(a,n,u),o.appendChild(s)}),this.m_oPageState.SetCondition(i)}RESULTCreateVoteCountAndFilter(e,t){"string"==typeof e&&(e=document.getElementById(e));let l=new CTableData({id:t.id,name:t.name});const o=t.table.header;CPageSuper.ReadColumnInformationFromHeader(l,o,(e,t,l)=>{t.key&&l.COLUMNSetPropertyValue(e,"position.hide",!0)}),l.ReadArray(t.table.body,{begin:0}),l.COLUMNSetType(l.ROWGet(1)),l.COLUMNUpdatePositionIndex(),l.COLUMNSetPropertyValue("ID_Answer","position.hide",!1);let a=l.CELLGetValue(0,0);for(let e=0,t=l.ROWGetCount();e<t;e++)this.m_oD3Bar.AddAnswer(a,[l.CELLGetValue(e,"PollAnswerK"),l.CELLGetValue(e,"FName"),0,0]);let i=e.querySelector(`section[data-question="${a}"]`),n=i.querySelector("article"),r={html_group:"table.table",html_row:"tr",html_cell_header:"th",html_cell:"td",html_section_header:"thead",html_section_body:"tbody",html_section_footer:"tfoot"},s=new CTableDataTrigger({table:l,trigger:CPageSuper.CallbackVote}),d={parent:n,section:["title","table.header","table.body","footer"],table:l,name:"vote",style:r,trigger:s},u=new CUITableText(d);l.UIAppend(u),u.COLUMNSetRenderer(0,(e,t,l)=>{e.innerHTML=`<button class="button is-primary is-light is-small" data-answer="${t}">Ta bort</button>`}),u.Render(),i=u.GetSection("body"),i.addEventListener("click",e=>{const t=e.srcElement;if("BUTTON"===t.tagName)if("string"==typeof t.dataset.uuid)this.QUERYGetPollFilterCount({condition:t.dataset.uuid}),t.className="button is-primary is-light is-small",t.innerText="Ta bort",delete t.dataset.uuid;else{const e=parseInt(t.dataset.answer,10);this.QUERYGetPollFilterCount({answer:e})}})}RESULTCreateSearch(e,t){"string"==typeof e&&(e=document.getElementById(e));let l=this.m_oUITableText.poll_search,o=l?l.data:null;if(o)return o.ClearData("body"),o.ReadArray(t.table.body,{begin:0}),l.Render(),void(l.row_page=t.page);o=new CTableData({id:t.id,name:t.name});const a=t.table.header;CPageSuper.ReadColumnInformationFromHeader(o,a,(e,t,l)=>{t.key&&l.COLUMNSetPropertyValue(e,"position.hide",!0)}),o.ReadArray(t.table.body,{begin:0}),o.ROWGetCount()>0&&o.COLUMNSetType(o.ROWGet(1)),o.COLUMNSetPropertyValue("FName","alias","Namn"),o.COLUMNSetPropertyValue("FDescription","alias","Beskrivning"),o.COLUMNSetPropertyValue("FBegin","alias","Start"),o.COLUMNSetPropertyValue("FEnd","alias","Slut"),o.COLUMNUpdatePositionIndex();let i=e;i.innerHTML="";let n={html_group:"table.table is-narrow is-hoverable is-fullwidth pointer",html_row:"tr",html_cell_header:"th",html_cell:"td",html_section_header:"thead",html_section_body:"tbody"},r=new CTableDataTrigger({table:o,trigger:(e,t)=>{if(131085===e.iEventAll){const t=e.information;if(-1===t[0])return;const l=t[3],o=e.data,a=o.CELLGetValue(l,"PollK");this.SetActiveState("body.select"),this.SetActivePoll(a)}else if(65560===e.iEventAll){const t=e.information,l=t.start+t.offset;return t.offset<0&&l>=0?this.QUERYGetSearch({start:l>0?l:0}):t.offset>0&&t.count===t.max&&this.QUERYGetSearch({start:l}),!1}}}),s=new CDispatch,d={dispatch:s,edit:!0,max:10,parent:e,section:["toolbar","table.header","table.body"],server:!0,style:n,table:o,trigger:r,callback_render:function(e,t,l,o){if("beforeInput"===e){let e=t.eElement.closest("tr"),l=e.closest("table");return l.querySelectorAll("tr").forEach(e=>e.classList.remove("selected")),e.classList.add("selected"),this.INPUTClear(),!1}}};l=new CUITableText(d),o.UIAppend(l),l.Render();let u=l.GetSection("header"),c=u.querySelectorAll("th");c.forEach(e=>{Object.assign(e.style,{backgroundColor:"var(--bs-white)",position:"sticky",top:"0px"})}),l.GetSection("body").focus({preventScroll:!0}),this.m_oUITableText.poll_search=l,e.dataset.one="1",this.SNAPSHOTGetFor("poll_search"),this.CallOwner("table",{name:"poll_search",tt:l,td:o})}HISTORYFindPoll(e){return-1!==this.m_aVoteHistory.findIndex(t=>t===e)}HISTORYSerialize(e){if(!0===e)localStorage.setItem("poll_votes",JSON.stringify(this.m_aVoteHistory));else{const e=localStorage.getItem("poll_votes");e&&(this.m_aVoteHistory=JSON.parse(e))}}static HISTORYSerializeSession(e,t){if(!0===e){const e={time:(new Date).toISOString(),session:t};localStorage.setItem("session",JSON.stringify(e))}else{const e=localStorage.getItem("session");if(e){const t=JSON.parse(e),l=new Date-Date.parse(t.time);if(l<36e5)return t.session}}return null}CONDITIONMarkFilterVote(e){let t=new CTableData;t.ReadObjects(e),this.m_bFilterConditionCount=!1;let l=t.ROWGetCount();for(;--l>=0;){const e=t.CELLGetValue(l,"condition_id");if("TieFilterAnswer"===e){this.m_bFilterConditionCount=!0;let e=this.ELEMENTGetFilterButton(parseInt(t.CELLGetValue(l,"value"),10));e.className="button is-warning is-light is-small",e.innerText="Lägg till",e.dataset.uuid=t.CELLGetValue(l,"uuid")}}}CONDITIONRemove(e,t){let l,o=this.app.request,a={command:"delete_condition_from_query get_result get_query_conditions",query:e,set:this.queries_set,count:100,format:1,start:0};void 0!==t?("string"==typeof t&&(a.uuid=t),o.Get("SCRIPT_Run",{file:"/PAGE_result.lua",hint:e,json:o.GetJson(a)},l)):o.Get("SCRIPT_Run",{file:"/PAGE_result.lua",hint:e,json:o.GetJson(a)},l)}SNAPSHOTGetFor(e){let t=this.app.request,l={command:"get_query_information",query:e,set:this.queries_set};t.Get("SCRIPT_Run",{file:"/PAGE_result.lua",json:t.GetJson(l)})}PAGECreateToolbarForSearch(e){let t=this.m_oUITableText.poll_search,l=t.GetSection("toolbar");if(l.style.display="flex",e.snapshots){let t=document.createElement("select");e.snapshots.forEach((l,o)=>{let a=document.createElement("option");a.value=l;let i=l;a.innerText=i,l===e.selected&&a.setAttribute("selected","selected"),t.appendChild(a)});let o=document.createElement("div");o.className="select is-primary",o.appendChild(t),l.appendChild(o),t.addEventListener("change",e=>{const t=e.srcElement.value;this.QUERYGetSearch({snapshot:t})})}{let e=this.m_oUITableText.poll_search.dispatch,t=this.m_oUITableText.poll_search,o=(t&&t.data,document.createElement("div"));o.style.display="inline-block",o.style.marginLeft="auto",l.appendChild(o);let a=new CUIPagerPreviousNext({dispatch:e,members:{page_max_count:10,page_count:t.ROWGetCount()},parent:o,callback_action:function(e,t){const[l,o]=e.split(".");if("render"===l||"create"===l){let e=t.eElement,o=e.querySelector('[data-type="previous"]'),a=e.querySelector('[data-type="next"]');if("create"===l)o.className="button is-primary is-outlined mr-1",a.className="button is-primary is-outlined";else{const e=this.members.page,t=this.members.page_count,l=this.members.page_max_count;0===e?(o.disabled=!0,o.innerText="Föregående"):(o.disabled=!1,o.innerText="Föregående ("+e+")"),t<l?(a.disabled=!0,a.innerText="Nästa"):(a.disabled=!1,a.innerText="Nästa ("+(e+2)+")")}}return!0}});e.AddChain(a,t),e.AddChain(t,[a])}}ELEMENTGetFilterButton(e){const t=document.getElementById("idPollFilterCount"),l=t.querySelector(`button[data-answer="${e}"]`);return l}}