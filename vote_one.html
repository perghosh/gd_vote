<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<body>

   <!--

   <label class="vote-check" data-style="rounded" data-color="green">
      <input checked type="checkbox" value="1">
      <span class="toggle">
         <span class="switch"></span>
      </span>
   </label>
   -->


   <div class="container">

      <div id="idUserMessage" data-section="information">
         <div id="idError" data-message style="display: none;">
            <div class="notification is-danger">
              <pre></pre>
              <button class="delete"></button>
            </div>         
         </div>
         <div id="idMessage" data-message style="display: none;">
            <div class="notification is-info">
              <p></p>
              <button class="delete"></button>
            </div>         
         </div>
         <div id="idWarning" data-message style="display: none;">
            <div class="notification is-warning">
              <p></p>
              <button class="delete"></button>
            </div>         
         </div>
      </div>


<!--
div[data-section="container"]
   div[data-section="tab"]
      [data-index="1"]
      [data-index="2"]
   div[data-section="content"]
      [data-index="1"]
      [data-index="2"]
-->
      <div data-section="container" data-page-type="vote">
         <div data-section="tab" class="tabs is-medium">
            <ul>
               <li class="is-active" data-index="1"><a data-translate="page.vote.Vote">Rösta</a></li>
               <li data-index="2"><a data-translate="page.vote.Result">Resultat</a></li>
               <li data-index="3"><a data-translate="page.vote.Search">Sök</a></li>
            </ul>
         </div>

         <!-- Header for poll, here the poll name and description is shown  -->
         <div id="idPollOverview" class="box has-background-success-light">
            <h1 class="title is-2" data-title></h1>
            <p data-description></p>
            <article class="panel has-background-white" data-section="link" style="display: none; margin-top: 1em; padding: 5px;">
               <p class="panel-heading" data-translate="page.vote.TitleLinks">Länkar</p>
            </article>               


            <!-- Present poll result as bar chart, one for each question-->
            <article class="panel" data-section="d3bars" style="width:  100%; margin-top: 1em; padding: 5px;">
            </article>

<!-- <i class="fas fa-chevron-down"></i> -->
            <div id="idResultVoteCount" class="box">
               <div><a class="is-pulled-right is-size-6 has-text-weight-semibold" style="position: relative; top: -0.7em;">Lista med antal röster&nbsp;<i class="fas fa-chevron-down"></i></a></div>
               <!-- Present poll result, after voter has voted or setting filter from vote count
                    This section is hidden from user and to show it user need to click on the button above
               -->
               <article class="has-background-white" data-view="none" data-section="result_vote_count" style="display: none; margin-top: 1em; padding: 5px;">
               </article>
            </div>
         </div>

         <div id="idContent" data-section="content">
            <!-- Vote section, here voter are able to vote, query = poll_question_list / poll_answer -->
            <article id="idPollVote" class="box is-active" data-index="1" data-state="body.vote">
            </article>

            <!-- Vote count is where votes for each answer is shown and buttons used to filter votes, query = poll_question_list / poll_answer_count -->
            <article id="idPollFilterCount" class="box" data-index="2" data-state="body.count">
            </article>

            <!-- Search for poll, this section presents search result, query = "poll_search"  -->
            <article id="idPollSearch" class="box" data-index="3" data-state="body.search" data-one="0">
            </article>
         </div>
      </div>
   </div>


   <script>
      function PAGE_Setup() {
         const sSession = CPageOne.HISTORYSerializeSession( false );
         window.app = new CApplication({ callback_action: PAGE_Callback, session: sSession });
         window.app.Initialize();
      }

      /**
       * Callback used by CPage class. CPage has the main page logic. Some logic is found here
       * @param sMessage type of operation
       */
      function PAGE_Callback(sOperation, data) {
         if( sOperation === "load" ) {                      // queries are loaded for user, here you can sart

            const sQueryString = window.location.search;
            const oParams = new URLSearchParams(sQueryString);
            if(oParams.has("poll") === false) {
               this.OpenMessage("Saknar id till aktiv fråga");
               return;
            }

            const iPoll = parseInt( oParams.get("poll"), 10 );
            if(isNaN(iPoll)) {
               this.OpenMessage("Felaktigt format för id till aktiv fråga");
               return;
            }

            this.SetActivePoll( iPoll );
         }
         else if( sOperation === "insert-voter" ) {
            window.app.page.OpenMessage("Användaren är registrerad och kan rösta efter att ha loggat in igen!");
         }
         else if( sOperation === "ready-poll-list" ) {
            if(this.state.read_url === true) {                                // check url for poll parameter
               delete this.state.read_url;
               this.URLReadSelectedPoll();
            }
         }
         else if(sOperation === "server-session") {
            if( !this.page) {
               this.m_oPage = new CPageOne(this, {callback_action: PAGE_Callback, read_url: true});
               const sSession = window.app.request.session;
               CPageOne.HISTORYSerializeSession( true, sSession );

               //this.m_oPage.SetActivePoll( 26 );
            }
         }
         else if(sOperation === "table") {
            if( data.name === "poll_search" ) {
               let e = data.tt.GetSection("body");
               e.classList.add("is-size-6");
               e = data.tt.GetSection("toolbar");
               e.style.marginBottom = "10px";
            }
         }
      }

      /*
       * ## Configure tabs. When user clicks on tab it should be activated and content is shown. 
       * - Send notification to page when tabs is activated.
       */
      const aTabs = document.querySelectorAll(".tabs");
      aTabs.forEach(eTabs => {
         eTabs.addEventListener("click", e => {
            let iTabIndex;
            let eTab = e.srcElement;
            let eContainer = eTab.closest('[data-section="container"]');
            let eContent = eContainer.querySelector('[data-section="content"]'); // get content container, content holds information related to tab
            if( eContent === null ) return;

            if(eTab.tagName === "A" || eTab.tagName === "LI") { // found tab ?
               let eHeader = eTab.closest(".tabs");
               eHeader.querySelectorAll(".is-active").forEach(e => { e.classList.remove("is-active"); }); // remove all active tabs

               // Set active tab
               if(eTab.tagName !== "LI") eTab = eTab.closest("li"); // go to LI Element
               eTab.classList.add("is-active" );
               iTabIndex = parseInt( eTab.dataset.index, 10 );
            }
            else return;
            console.assert( typeof iTabIndex === "number", "no number for page index, something is wrong in markup" );
            
            eContent.querySelectorAll(".is-active").forEach(e => { e.classList.remove("is-active"); }); // close all content pages

            // Open content page for tab
            eContent = eContent.querySelector(`[data-index="${iTabIndex}"]`);
            eContent.classList.add("is-active");

            // ## Process page operation based on what tab that is selected
            if(eContainer.dataset.pageType === "vote") {
               const oPage = window.app.page;

               //
               // ## Set current state for vote page
               // ## Here we open voting, filter or select poll
               //

               if( eContent.dataset.one === "1") return;                        // Do we need to get result for this again, if 1 then information is set
               oPage.SetActiveState(eContent.dataset.state, eContent);          // Set the page state for vote section (results or voting)
               if(oPage.GetActivePoll() > 0) oPage.SetActivePoll(oPage.GetActivePoll());
            }
         });

      });

      // handle close button in message section
      let eUserMessage = document.getElementById("idUserMessage");
      eUserMessage.addEventListener("click", e => { 
         if( e.srcElement.tagName === "BUTTON") {
            let eMessage = e.srcElement.closest("[data-message]");
            eMessage.style.display = "none"; 
         }
      });

      let eVoteCountAnchor = document.getElementById("idResultVoteCount").querySelector("a");
      eVoteCountAnchor.addEventListener("click", e => { 
         let eContanier = e.target.closest(".box");

         let eI = eContanier.querySelector("a").querySelector("i");
         let eArticle = eContanier.querySelector("article");
         if( eArticle.dataset.view === "none") {
            eArticle.dataset.view = "block";
            eArticle.style.display = "block";
            eI.className = "fas fa-chevron-up";
         }
         else {
            eArticle.dataset.view = "none";
            eArticle.style.display = "none";
            eI.className = "fas fa-chevron-down";
         }
      });

      /*
       * ## Configure special elements in page
       * - Close button for message
       */



   </script>



   <!--
    | Load needed components to manage login and vote data
   -->
   <script type="module">
      // #region LOAD_PAGE_COMPONENETS


      import { edit } from "./library/TableDataEdit.js";
      import { CTableData, browser } from "./library/TableData.js";
      import { CTableDataTrigger } from "./library/TableDataTrigger.js";
      import { SetTriggerName } from "./library/TableDataTriggerNames.js";
      import { CUITableText } from "./library/UITableText.js";
      import { CUIPagerPreviousNext } from "./library/UIPagerPreviousNext.js";
      import { CDispatch } from "./library/Dispatch.js";

      import { CRequest } from "./server/ServerRequest.js";
      import { CQuery } from "./server/Query.js";

      import { CApplication } from "./application/application.js";
      import { CPageOne } from "./application/pageone.js";
      


      window.edit = edit;
      window.CTableData = CTableData;
      window.CTableData_browser = browser;
      window.CUITableText = CUITableText;
      window.CTableDataTrigger = CTableDataTrigger;
      window.CUIPagerPreviousNext = CUIPagerPreviousNext;
      window.CDispatch = CDispatch;

      window.CApplication = CApplication;
      //window.CPageSuper = CPageSuper;
      window.CPageOne = CPageOne;

      SetTriggerName();

      window.CRequest = CRequest;
      window.CQuery = CQuery;

      window.onerror = function(sMessage, sUrl, iLine) {
         if(typeof sMessage === "string") {
            sMessage += "\n" + sUrl + "\nLine: " + iLine;
            window.app.page.OpenMessage(sMessage, "error");
         }
      };


      document.addEventListener('DOMContentLoaded', function() {
         PAGE_Setup();
      });


      var aLogon = [
         [ "Namn", "E-Mejl", "Lösenord" ],
         [ "?", "?", "?" ]
      ];
// #endregion
   </script>


</body>
<head>
   <meta charset="iso-8859-1">
   <title>Vote</title>
   <!-- Bulma css -->
   <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
   <!-- fontawesome -->
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" />

   <!-- d3 -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.7.0/d3.js"></script>
   <style>
      :root {
         --gd-blue: #0d6efd;
         --gd-indigo: #6610f2;
         --gd-purple: #6f42c1;
         --gd-pink: #d63384;
         --gd-red: #dc3545;
         --gd-orange: #fd7e14;
         --gd-yellow: #ffc107;
         --gd-green: #198754;
         --gd-teal: #20c997;
         --gd-cyan: #0dcaf0;
         --gd-white: #fff;
         --gd-gray: #6c757d;
         --gd-gray-dark: #343a40;
         --gd-gray-light: #e9e8eb;
         --gd-primary: #0d6efd;
         --gd-secondary: #6c757d;
         --gd-success: #198754;
         --gd-info: #0dcaf0;
         --gd-warning: #ffc107;
         --gd-danger: #dc3545;
         --gd-light: #f8f9fa;
         --gd-dark: #212529;
         --gd-font-sans-serif: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
         --gd-font-monospace: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }


      body {
         color: #212529;
         margin: 0;
         font-family: var(--gd-font-sans-serif);
         font-size: 1rem;
         font-weight: 400;
         line-height: 1.5;
         background-color: #fff;
      }

      section, tbody {
         outline: none;
      }

      .selected {
         background-color: var(--gd-gray-light);
      }

      .checked {
         display: inline-block;
         width: 16px;
         height: 16px;
         background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-check2-square' viewBox='0 0 16 16'> <path d='M3 14.5A1.5 1.5 0 0 1 1.5 13V3A1.5 1.5 0 0 1 3 1.5h8a.5.5 0 0 1 0 1H3a.5.5 0 0 0-.5.5v10a.5.5 0 0 0 .5.5h10a.5.5 0 0 0 .5-.5V8a.5.5 0 0 1 1 0v5a1.5 1.5 0 0 1-1.5 1.5H3z'/> <path d='M8.354 10.354l7-7a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0z'/> </svg>");
      }

      table.pointer td { cursor: pointer; }

      /* CSS to show or hide tabs and its content */
      div[data-section="content"] article {
         display: none;
      }

      div[data-section="content"] article.is-active {
         display: block;
      }

      .d3_bar, .d3_label {
        font-size: 10pt;
        font-weight: bold;
        font-family: Arial, sans-serif;
      }
      
      .malebar {
        fill: steelblue;
      }      


      /* Customizable styles  https://github.com/adamculpepper/toggle-switchy*/

/* Colors: Default (blue) */
.vote-check {color:#fff;}
.vote-check > input + .toggle:before {content:'RÖST';}
.vote-check > input + .toggle:after {content:'-';}
.vote-check > input + .toggle > .switch {background:#fff;}
.vote-check > input + .toggle + .label {color:#000;}
.vote-check > input:checked + .toggle {background:#3498db;}
.vote-check > input:not(:checked) + .toggle {background:#ccc;}
.vote-check > input:checked + .toggle > .switch {border:3px solid #3498db;}
.vote-check > input:not(:checked) + .toggle > .switch {border:3px solid #ccc;}
.vote-check > input:focus + .toggle,
.vote-check > input:active + .toggle {box-shadow:0 0 5px 3px rgba(0, 119, 200, 0.50);}

/* Rounded switch corners */
.vote-check > input + .toggle {border-radius:4px;}
.vote-check > input + .toggle .switch {border-radius:6px;}

/* //////////////////////////
CORE STYLES BELOW - NO TOUCHY
////////////////////////// */
.vote-check {display:inline-flex; align-items:center; user-select:none; position:relative; vertical-align:middle; margin-bottom:0;}
.vote-check:hover {cursor:pointer;}
.vote-check > input {position:absolute; opacity:0;}
.vote-check > input + .toggle {align-items:center; position:relative;}
.vote-check > input + .toggle {overflow:hidden; position:relative; flex-shrink:0;}
.vote-check > input[disabled] + .toggle {opacity:0.5;}
.vote-check > input[disabled] + .toggle:hover {cursor:not-allowed;}
.vote-check > input + .toggle {width:100%; height:100%; margin:0; cursor:pointer;}
.vote-check > input + .toggle > .switch {display:block; height:100%; position:absolute; right:0; z-index:3; box-sizing:border-box;}

/* Labels */
.vote-check > input + .toggle:before,
.vote-check > input + .toggle:after {display:flex; align-items:center; position:absolute; z-index:2; height:100%;}
.vote-check > input + .toggle:before {right:55%;}
.vote-check > input + .toggle:after {left:50%;}
.vote-check > input + .toggle + .label {margin-left:10px;}
.vote-check[data-label='left'] > input + .toggle {order:2;}
.vote-check[data-label='left'] > input + .toggle + .label {order:1; margin-left:0; margin-right:10px;}

/* Show / Hide */
.vote-check > input + .toggle:before {opacity:0;}
.vote-check > input:checked + .toggle:before {opacity:1;}
.vote-check > input:checked + .toggle:after {opacity:0;}

/* Transitions */
.vote-check > input + .toggle {transition:background 200ms linear, box-shadow 200ms linear;}
.vote-check > input + .toggle:before,
.vote-check > input + .toggle:after {transition:all 200ms linear;}
.vote-check > input + .toggle > .switch {transition:right 200ms linear, border-color 200ms linear;}


/* Rounded switch corners */
.vote-check > input + .toggle {border-radius:4px;}
.vote-check > input + .toggle .switch {border-radius:6px;}

/* Size: Large */
.vote-check[data-size='lg'] > input + .toggle				{width:95px; height:35px;}
.vote-check[data-size='lg'] > input + .toggle > .switch	{width:35px;}
.vote-check[data-size='lg'] > input + .toggle:before,
.vote-check[data-size='lg'] > input + .toggle:after		{font-size:1rem;}
.vote-check[data-size='lg'] > input:not(:checked) + .toggle > .switch {right:calc(100% - 35px);}


/* Style: Rounded */
.vote-check[data-style='rounded'] > input + .toggle,
.vote-check[data-style='rounded'] > input + .toggle > .switch {border-radius:50px;}
.vote-check[data-style='rounded'] > input + .toggle:before {right:50%;}
.vote-check[data-style='rounded'] > input + .toggle:after {left:50%;}

/* Color: Green */
.vote-check[data-color='green'] > input:checked + .toggle {background:#00d1b2;}
.vote-check[data-color='green'] > input:checked + .toggle > .switch {border-color:#00d1b2;}
      </style>

</head>
</html>